<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pe√±a La Parrilla - Gesti√≥n de Gastos e Ingresos</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1, h2, h3 {
            color: #d35400;
        }
        .container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        button {
            background-color: #e67e22;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            text-decoration: none;
            display: inline-block;
        }
        button:hover {
            background-color: #d35400;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f8e9db;
        }
        .balance {
            font-weight: bold;
            font-size: 1.2em;
            margin: 15px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .positive { color: #27ae60; }
        .negative { color: #c0392b; }
        .zero { color: #7f8c8d; }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            margin-right: 5px;
        }
        .tab.active {
            background-color: white;
            border-bottom: 1px solid white;
            margin-bottom: -1px;
            font-weight: bold;
        }
        .tab-content {
            display: none;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 0 4px 4px 4px;
            background-color: white;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Pe√±a La Parrilla</h1>
        <h2>Gesti√≥n de Gastos e Ingresos</h2>
        <p>Para a√±adir un evento, ingreso o gasto, haz clic en el bot√≥n de abajo.</p>
        <a href="https://docs.google.com/forms/d/e/TU-ID-DEL-FORMULARIO/edit" target="_blank">
            <button>+ A√±adir Movimiento o Evento</button>
        </a>
    </div>

    <div id="eventosTabs" class="tabs">
        <div class="tab active" data-evento="general">General</div>
    </div>

    <div id="eventosContents">
        <div class="tab-content active" id="content-general">
            <h3>Movimientos Generales</h3>
            <table id="tablaGeneral">
                <thead>
                    <tr>
                        <th>Tipo</th>
                        <th>Nombre</th>
                        <th>Cantidad (‚Ç¨)</th>
                        <th>Concepto</th>
                        <th>Fecha</th>
                    </tr>
                </thead>
                <tbody id="listaGeneral">
                    <!-- Se llenar√° con JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // === üîî PON AQU√ç LA URL DE TU HOJA PUBLICADA EN CSV ===
        const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSLc173I_1hDV-46WLxS55oLHAxhCAH6D1-EGIzn1_r37uG1KP93zmgEnsiTxOEvVbaX0QcdgPJEvCS/pub?gid=1399730895&single=true&output=csv";

        let eventos = { general: { nombre: "General", ingresos: [], gastos: [] } };

        async function cargarDatos() {
            try {
                const resp = await fetch(CSV_URL);
                const csv = await resp.text();
                const filas = csv.split('\n').slice(1); // Saltar encabezados

                filas.filter(f => f.trim()).forEach(fila => {
                    const celdas = fila.split(',').map(c => c.trim().replace(/"/g, ''));
                    
                    const fecha = celdas[0];
                    const tipoRegistro = celdas[1];
                    const nombreEvento = celdas[2] || 'general';
                    const nombre = celdas[3];
                    const cantidad = parseFloat(celdas[4]) || 0;
                    const concepto = celdas[5];

                    // Crear evento si no existe
                    if (tipoRegistro === 'Crear Evento' && nombreEvento !== 'general') {
                        eventos[nombreEvento.toLowerCase().replace(/[^a-z0-9]/g, '')] = {
                            nombre: nombreEvento,
                            ingresos: [],
                            gastos: []
                        };
                    }

                    // A√±adir ingreso o gasto
                    if (tipoRegistro === 'A√±adir Ingreso') {
                        const evento = eventos[nombreEvento.toLowerCase().replace(/[^a-z0-9]/g, '')] || eventos.general;
                        evento.ingresos.push({ nombre, cantidad, concepto, fecha });
                    }
                    if (tipoRegistro === 'A√±adir Gasto') {
                        const evento = eventos[nombreEvento.toLowerCase().replace(/[^a-z0-9]/g, '')] || eventos.general;
                        evento.gastos.push({ nombre, cantidad, concepto, fecha });
                    }
                });

                reconstruirInterfaz();
                actualizarTablaGeneral();
            } catch (error) {
                console.error("Error al cargar datos:", error);
            }
        }

        function reconstruirInterfaz() {
            const tabs = document.getElementById('eventosTabs');
            const contents = document.getElementById('eventosContents');
            tabs.innerHTML = '<div class="tab active" data-evento="general">General</div>';
            contents.innerHTML = document.getElementById('content-general').outerHTML;

            Object.keys(eventos).forEach(id => {
                const tab = document.createElement('div');
                tab.className = 'tab';
                tab.textContent = eventos[id].nombre;
                tab.setAttribute('data-evento', id);
                tab.addEventListener('click', cambiarTab);
                tabs.appendChild(tab);

                const content = document.createElement('div');
                content.className = 'tab-content';
                content.id = `content-${id}`;
                content.innerHTML = crearContenidoEvento(id);
                contents.appendChild(content);
                actualizarBalance(id);
            });
        }

        function crearContenidoEvento(idEvento) {
            const ev = eventos[idEvento];
            const ingresos = ev.ingresos.map(i => `
                <tr>
                    <td>${i.nombre}</td>
                    <td>${i.cantidad.toFixed(2)}</td>
                    <td>${i.concepto}</td>
                    <td>${i.fecha}</td>
                </tr>
            `).join('');

            const gastos = ev.gastos.map(g => `
                <tr>
                    <td>${g.nombre}</td>
                    <td>${g.cantidad.toFixed(2)}</td>
                    <td>${g.concepto}</td>
                    <td>${g.fecha}</td>
                </tr>
            `).join('');

            return `
                <h3>${ev.nombre}</h3>
                <div class="container">
                    <h4>Ingresos</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Cantidad (‚Ç¨)</th>
                                <th>Concepto</th>
                                <th>Fecha</th>
                            </tr>
                        </thead>
                        <tbody>${ingresos}</tbody>
                    </table>
                </div>
                <div class="container">
                    <h4>Gastos</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Cantidad (‚Ç¨)</th>
                                <th>Concepto</th>
                                <th>Fecha</th>
                            </tr>
                        </thead>
                        <tbody>${gastos}</tbody>
                    </table>
                </div>
                <div class="container">
                    <h3>Balance</h3>
                    <div id="balance-${idEvento}" class="balance zero">Calculando...</div>
                </div>
            `;
        }

        function cambiarTab(e) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            e.target.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`content-${e.target.getAttribute('data-evento')}`).classList.add('active');
        }

        function actualizarTablaGeneral() {
            const lista = document.getElementById('listaGeneral');
            lista.innerHTML = '';
            Object.values(eventos).forEach(ev => {
                ev.ingresos.forEach(i => {
                    const fila = document.createElement('tr');
                    fila.innerHTML = `
                        <td>Ingreso (${ev.nombre})</td>
                        <td>${i.nombre}</td>
                        <td>${i.cantidad.toFixed(2)}</td>
                        <td>${i.concepto}</td>
                        <td>${i.fecha}</td>
                    `;
                    lista.appendChild(fila);
                });
                ev.gastos.forEach(g => {
                    const fila = document.createElement('tr');
                    fila.innerHTML = `
                        <td>Gasto (${ev.nombre})</td>
                        <td>${g.nombre}</td>
                        <td>${g.cantidad.toFixed(2)}</td>
                        <td>${g.concepto}</td>
                        <td>${g.fecha}</td>
                    `;
                    lista.appendChild(fila);
                });
            });
        }

        function actualizarBalance(idEvento) {
            const ev = eventos[idEvento];
            if (!ev) return;
            const totalIngresos = ev.ingresos.reduce((a,b) => a+b.cantidad, 0);
            const totalGastos = ev.gastos.reduce((a,b) => a+b.cantidad, 0);
            const balance = totalIngresos - totalGastos;
            const el = document.getElementById(`balance-${idEvento}`);
            el.textContent = `Balance: ${balance.toFixed(2)} ‚Ç¨`;
            el.className = 'balance ' + (balance > 0 ? 'positive' : balance < 0 ? 'negative' : 'zero');
        }

        // Cargar datos al inicio
        window.addEventListener('load', cargarDatos);
    </script>
</body>
</html>