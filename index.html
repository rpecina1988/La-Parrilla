<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peña La Parrilla - Gestión de Gastos e Ingresos</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1, h2, h3 {
            color: #d35400;
        }
        .container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        button {
            background-color: #e67e22;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            text-decoration: none;
            display: inline-block;
        }
        button:hover {
            background-color: #d35400;
        }
        .export-btn {
            background-color: #27ae60;
        }
        .export-btn:hover {
            background-color: #219955;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f8e9db;
        }
        .balance {
            font-weight: bold;
            font-size: 1.2em;
            margin: 15px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .positive { color: #27ae60; }
        .negative { color: #c0392b; }
        .zero { color: #7f8c8d; }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            margin-right: 5px;
        }
        .tab.active {
            background-color: white;
            border-bottom: 1px solid white;
            margin-bottom: -1px;
            font-weight: bold;
        }
        .tab-content {
            display: none;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 0 4px 4px 4px;
            background-color: white;
        }
        .tab-content.active {
            display: block;
        }
        .export-container {
            margin: 15px 0;
            display: flex;
            gap: 10px;
        }
        .loading {
            color: #7f8c8d;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Peña La Parrilla</h1>
        <h2>Gestión de Gastos e Ingresos</h2>
        <p><strong>Estado:</strong> <span id="status" class="loading">Cargando datos desde Google Sheets...</span></p>
        <a href="https://forms.gle/r2Bya4DTVU94JENs5" target="_blank">
            <button>+ Añadir Movimiento o Evento</button>
        </a>
    </div>

    <div id="eventosTabs" class="tabs">
        <div class="tab active" data-evento="general">General</div>
    </div>

    <div id="eventosContents">
        <div class="tab-content active" id="content-general">
            <h3>Movimientos Generales</h3>
            <table id="tablaGeneral">
                <thead>
                    <tr>
                        <th>Tipo</th>
                        <th>Nombre</th>
                        <th>Cantidad (€)</th>
                        <th>Concepto</th>
                        <th>Fecha</th>
                    </tr>
                </thead>
                <tbody id="listaGeneral">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // URL del CSV publicado
        const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSLc173I_1hDV-46WLxS55oLHAxhCAH6D1-EGIzn1_r37uG1KP93zmgEnsiTxOEvVbaX0QcdgPJEvCS/pub?output=csv";

        // Estructura: { idEvento: { nombre: "Nombre", ingresos: [...], gastos: [...] } }
        let eventos = { general: { nombre: "General", ingresos: [], gastos: [] } };

        const status = document.getElementById('status');
        const listaGeneral = document.getElementById('listaGeneral');

        // Función para normalizar nombres de eventos (sin espacios, minúsculas)
        function normalizarNombre(nombre) {
            return nombre.trim().toLowerCase().replace(/[^a-z0-9áéíóúñ]/g, '');
        }

        // Parser de CSV mejorado
        function parseCSV(csv) {
            const lines = csv.split(/\r\n|\n/);
            const result = [];
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                const row = [];
                let field = "";
                let inQuotes = false;
                for (let char of lines[i]) {
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        row.push(field.trim().replace(/^"|"$/g, ''));
                        field = "";
                    } else {
                        field += char;
                    }
                }
                row.push(field.trim().replace(/^"|"$/g, ''));
                result.push(row);
            }
            return result;
        }

        async function cargarDatos() {
            try {
                const resp = await fetch(CSV_URL + "&t=" + Date.now());
                if (!resp.ok) throw new Error("HTTP " + resp.status);
                const csv = await resp.text();
                if (!csv.trim()) throw new Error("CSV vacío");

                const filas = parseCSV(csv);
                let eventosCreados = 0;

                filas.forEach(celdas => {
                    if (celdas.length < 6) return;

                    const marcaTiempo = celdas[0];
                    const tipoRegistro = (celdas[1] || '').trim();
                    let nombreEventoInput = (celdas[2] || '').trim();
                    const nombre = (celdas[3] || 'Sin nombre').trim();
                    const cantidadTexto = (celdas[4] || '0').trim();
                    const cantidad = parseFloat(cantidadTexto.replace(',', '.')) || 0;
                    const concepto = (celdas[5] || 'Sin concepto').trim();
                    const fecha = marcaTiempo.split(' ')[0]; // Solo la fecha

                    // Si no hay nombre de evento, usar "general"
                    if (!nombreEventoInput && tipoRegistro !== 'Crear Evento') {
                        nombreEventoInput = 'General';
                    }

                    // Normalizar nombre
                    const nombreNormalizado = normalizarNombre(nombreEventoInput || 'general');
                    const nombreReal = nombreEventoInput || 'General';

                    // Crear evento si no existe
                    if (tipoRegistro === 'Crear Evento' && nombreEventoInput) {
                        eventos[nombreNormalizado] = {
                            nombre: nombreReal,
                            ingresos: [],
                            gastos: []
                        };
                        eventosCreados++;
                    }

                    // Añadir ingreso o gasto
                    if (tipoRegistro === 'Añadir Ingreso') {
                        if (!eventos[nombreNormalizado]) {
                            eventos[nombreNormalizado] = { nombre: nombreReal, ingresos: [], gastos: [] };
                        }
                        eventos[nombreNormalizado].ingresos.push({ nombre, cantidad, concepto, fecha });
                    }

                    if (tipoRegistro === 'Añadir Gasto') {
                        if (!eventos[nombreNormalizado]) {
                            eventos[nombreNormalizado] = { nombre: nombreReal, ingresos: [], gastos: [] };
                        }
                        eventos[nombreNormalizado].gastos.push({ nombre, cantidad, concepto, fecha });
                    }
                });

                if (eventosCreados === 0 && Object.keys(eventos).length === 1) {
                    throw new Error("No se encontraron eventos. ¿Has enviado 'Crear Evento'?");
                }

                reconstruirInterfaz();
                actualizarTablaGeneral();
                actualizarEstado(`✅ Datos cargados: ${Object.keys(eventos).length - 1} eventos`, false);
            } catch (error) {
                actualizarEstado("❌ Error: " + error.message, true);
                console.error("Error al cargar datos:", error);
            }
        }

        function reconstruirInterfaz() {
            const tabs = document.getElementById('eventosTabs');
            const contents = document.getElementById('eventosContents');
            tabs.innerHTML = '<div class="tab active" data-evento="general">General</div>';
            contents.innerHTML = document.getElementById('content-general').outerHTML;

            Object.keys(eventos).forEach(id => {
                const tab = document.createElement('div');
                tab.className = 'tab';
                tab.textContent = eventos[id].nombre;
                tab.setAttribute('data-evento', id);
                tab.addEventListener('click', cambiarTab);
                tabs.appendChild(tab);

                const content = document.createElement('div');
                content.className = 'tab-content';
                content.id = `content-${id}`;
                content.innerHTML = crearContenidoEvento(id);
                contents.appendChild(content);
                actualizarBalance(id);
            });
        }

        function crearContenidoEvento(idEvento) {
            const ev = eventos[idEvento];
            const ingresos = ev.ingresos.map(i => `
                <tr>
                    <td>${i.nombre}</td>
                    <td>${i.cantidad.toFixed(2)}</td>
                    <td>${i.concepto}</td>
                    <td>${i.fecha}</td>
                </tr>
            `).join('');

            const gastos = ev.gastos.map(g => `
                <tr>
                    <td>${g.nombre}</td>
                    <td>${g.cantidad.toFixed(2)}</td>
                    <td>${g.concepto}</td>
                    <td>${g.fecha}</td>
                </tr>
            `).join('');

            return `
                <h3>${ev.nombre}</h3>
                <div class="export-container">
                    <button class="export-btn" onclick="exportarEventoAExcel('${idEvento}')">Exportar a Excel</button>
                    <button class="export-btn" onclick="exportarEventoAPDF('${idEvento}')">Exportar a PDF</button>
                </div>
                <div class="container">
                    <h4>Ingresos</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Cantidad (€)</th>
                                <th>Concepto</th>
                                <th>Fecha</th>
                            </tr>
                        </thead>
                        <tbody>${ingresos}</tbody>
                    </table>
                </div>
                <div class="container">
                    <h4>Gastos</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Cantidad (€)</th>
                                <th>Concepto</th>
                                <th>Fecha</th>
                            </tr>
                        </thead>
                        <tbody>${gastos}</tbody>
                    </table>
                </div>
                <div class="container">
                    <h3>Balance</h3>
                    <div id="balance-${idEvento}" class="balance zero">Calculando...</div>
                </div>
            `;
        }

        function cambiarTab(e) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            e.target.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`content-${e.target.getAttribute('data-evento')}`).classList.add('active');
        }

        function actualizarTablaGeneral() {
            listaGeneral.innerHTML = '';
            Object.values(eventos).forEach(ev => {
                ev.ingresos.forEach(i => {
                    const fila = document.createElement('tr');
                    fila.innerHTML = `
                        <td>Ingreso (${ev.nombre})</td>
                        <td>${i.nombre}</td>
                        <td>${i.cantidad.toFixed(2)}</td>
                        <td>${i.concepto}</td>
                        <td>${i.fecha}</td>
                    `;
                    listaGeneral.appendChild(fila);
                });
                ev.gastos.forEach(g => {
                    const fila = document.createElement('tr');
                    fila.innerHTML = `
                        <td>Gasto (${ev.nombre})</td>
                        <td>${g.nombre}</td>
                        <td>${g.cantidad.toFixed(2)}</td>
                        <td>${g.concepto}</td>
                        <td>${g.fecha}</td>
                    `;
                    listaGeneral.appendChild(fila);
                });
            });
        }

        function actualizarBalance(idEvento) {
            const ev = eventos[idEvento];
            if (!ev) return;
            const totalIngresos = ev.ingresos.reduce((a,b) => a+b.cantidad, 0);
            const totalGastos = ev.gastos.reduce((a,b) => a+b.cantidad, 0);
            const balance = totalIngresos - totalGastos;
            const el = document.getElementById(`balance-${idEvento}`);
            el.textContent = `Balance: ${balance.toFixed(2)} €`;
            el.className = 'balance ' + (balance > 0 ? 'positive' : balance < 0 ? 'negative' : 'zero');
        }

        function exportarEventoAExcel(idEvento) {
            const { utils, writeFile } = XLSX;
            const wb = utils.book_new();
            const ev = eventos[idEvento];
            
            const ingresosData = [['Nombre','Cantidad (€)','Concepto','Fecha']];
            ev.ingresos.forEach(i => ingresosData.push([i.nombre, i.cantidad, i.concepto, i.fecha]));
            utils.book_append_sheet(wb, utils.aoa_to_sheet(ingresosData), "Ingresos");
            
            const gastosData = [['Nombre','Cantidad (€)','Concepto','Fecha']];
            ev.gastos.forEach(g => gastosData.push([g.nombre, g.cantidad, g.concepto, g.fecha]));
            utils.book_append_sheet(wb, utils.aoa_to_sheet(gastosData), "Gastos");
            
            writeFile(wb, `${ev.nombre}.xlsx`);
        }

        function exportarEventoAPDF(idEvento) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const ev = eventos[idEvento];
            doc.text(ev.nombre, 14, 20);
            
            const ingresosData = ev.ingresos.map(i => [i.nombre, i.cantidad.toFixed(2), i.concepto, i.fecha]);
            if (ingresosData.length > 0) {
                doc.autoTable({
                    head: [['Nombre','Cantidad (€)','Concepto','Fecha']],
                    body: ingresosData,
                    startY: 30
                });
            }
            
            const finalY = doc.lastAutoTable ? doc.lastAutoTable.finalY + 10 : 40;
            const gastosData = ev.gastos.map(g => [g.nombre, g.cantidad.toFixed(2), g.concepto, g.fecha]);
            if (gastosData.length > 0) {
                doc.autoTable({
                    head: [['Nombre','Cantidad (€)','Concepto','Fecha']],
                    body: gastosData,
                    startY: finalY
                });
            }
            
            doc.save(`${ev.nombre}.pdf`);
        }

        function actualizarEstado(mensaje, error = false) {
            status.textContent = mensaje;
            status.style.color = error ? 'red' : 'green';
        }

        window.addEventListener('load', cargarDatos);
    </script>
</body>
</html>